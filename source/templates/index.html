<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #map {
            height: 500px;
            width: 80%;
            margin: 20px auto;
        }

        select {
            padding: 10px;
            font-size: 16px;
        }

        #button {
            height: 40px;
            width: 65px;
            background-color: rgb(84, 188, 196);
            border-radius: 5px;
            font-size: 15px;
            cursor: pointer;
        }

        #nomeUsuario {
            height: 35px;
            width: 200px;
            text-align: center;
            font-size: 15px;
        }

    </style>
</head>
<body>
    <h1>Selecione o estado do Brasil em que você reside</h1>
    <select id="estadoSelect">
        <option value="">Selecione um estado</option>
    </select>
    <div id="map"></div>

    <input type="text" id="nomeUsuario" placeholder="Digite seu nome" />
    <button id="button" onclick="enviarDados()">Enviar</button>

    <script>
        window.onload = function() {
            let map = L.map('map').setView([-14.2350, -51.9253], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            let estadoLayer;
        
            fetch('/estados')
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById('estadoSelect');
                    data.estados.forEach(estado => {
                        let option = document.createElement('option');
                        option.value = estado;
                        option.textContent = estado;
                        select.appendChild(option);
                    });
                });
        
            document.getElementById('estadoSelect').addEventListener('change', function() {
                let estado = this.value;
                if (estado) {
                    fetch(`/estado?nome=${estado}`)
                        .then(response => response.json())
                        .then(data => {
                            if (estadoLayer) {
                                map.removeLayer(estadoLayer);
                            }
                            estadoLayer = L.geoJSON(JSON.parse(data.geojson), {
                                style: { color: 'red', weight: 2 }
                            }).addTo(map);
                            map.fitBounds(estadoLayer.getBounds());
                        });
                }
            });
        }

        function enviarDados() {
            let nome = document.getElementById('nomeUsuario').value;
            let estado = document.getElementById('estadoSelect').value;
            
            if (nome.trim() === "" || estado.trim() === "") {
                alert("Por favor, digite seu nome e selecione o estado que você mora.");
                return;
            }

            console.log('Enviando dados:', { nome: nome, estado: estado });
    
            fetch('/salvar_dados', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome: nome, estado: estado })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.mensagem);
                console.log('Resposta do servidor:', data);
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar os dados!');
            });
        }
    </script>
</body>
